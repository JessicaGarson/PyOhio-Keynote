<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyOhio Elasticsearch Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <div class="search-card">
            <div class="content">
                <div class="d-flex align-items-center mb-4">
                    <div class="python-logo me-3">
                        <svg viewBox="0 0 128 128" width="48" height="48">
                            <linearGradient id="python-original-a" gradientUnits="userSpaceOnUse" x1="70.252" y1="1237.476" x2="170.659" y2="1151.089" gradientTransform="matrix(.563 0 0 -.568 -29.215 707.817)">
                                <stop offset="0" stop-color="#5A9FD4"></stop>
                                <stop offset="1" stop-color="#306998"></stop>
                            </linearGradient>
                            <linearGradient id="python-original-b" gradientUnits="userSpaceOnUse" x1="209.474" y1="1098.811" x2="173.62" y2="1149.537" gradientTransform="matrix(.563 0 0 -.568 -29.215 707.817)">
                                <stop offset="0" stop-color="#FFD43B"></stop>
                                <stop offset="1" stop-color="#FFE873"></stop>
                            </linearGradient>
                            <path fill="url(#python-original-a)" d="M63.391 1.988c-4.222.02-8.252.379-11.8 1.007-10.45 1.846-12.346 5.71-12.346 12.837v9.411h24.693v3.137H29.977c-7.176 0-13.46 4.313-15.426 12.521-2.268 9.405-2.368 15.275 0 25.096 1.755 7.311 5.947 12.519 13.124 12.519h8.491V67.234c0-8.151 7.051-15.34 15.426-15.34h24.665c6.866 0 12.346-5.654 12.346-12.548V15.833c0-6.693-5.646-11.72-12.346-12.837-4.244-.706-8.645-1.027-12.866-1.008zM50.037 9.557c2.55 0 4.634 2.117 4.634 4.721 0 2.593-2.083 4.69-4.634 4.69-2.56 0-4.633-2.097-4.633-4.69-.001-2.604 2.073-4.721 4.633-4.721z" transform="translate(0 10.26)"></path>
                            <path fill="url(#python-original-b)" d="M91.682 28.38v10.966c0 8.5-7.208 15.655-15.426 15.655H51.591c-6.756 0-12.346 5.783-12.346 12.549v23.515c0 6.691 5.818 10.628 12.346 12.547 7.816 2.297 15.312 2.713 24.665 0 6.216-1.801 12.346-5.423 12.346-12.547v-9.412H63.938v-3.138h37.012c7.176 0 9.852-5.005 12.348-12.519 2.578-7.735 2.467-15.174 0-25.096-1.774-7.145-5.161-12.521-12.348-12.521h-9.268zM77.809 87.927c2.561 0 4.634 2.097 4.634 4.692 0 2.602-2.074 4.719-4.634 4.719-2.55 0-4.633-2.117-4.633-4.719 0-2.595 2.083-4.692 4.633-4.692z" transform="translate(0 10.26)"></path>
                        </svg>
                    </div>
                    <h1>PyOhio Elasticsearch Demo</h1>
                </div>
                
                <div class="search-container">
                    <form id="search-form" class="mb-4">
                        <div class="input-group">
                            <input type="text" id="search-input" class="form-control" placeholder="Search for Python, Flask, Ohio tech..." aria-label="Search">
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </form>
                    
                    {% if not es_available %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i> 
                        Elasticsearch connection is not available. Please check your configuration.
                    </div>
                    {% endif %}
                    
                    <div id="search-results" class="mt-4">
                        <div class="row">
                            <div class="col-md-8">
                                <div id="results-container">
                                    <div class="welcome-message">
                                        <h2>Welcome to the PyOhio Elasticsearch Demo!</h2>
                                        <p class="lead">This demo showcases the power of Elasticsearch with Python and Flask.</p>
                                        <p>Try searching for topics like "python", "flask", "ohio", or "elasticsearch" to see the results.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="stats-container">
                                    <h3>Search Analytics</h3>
                                    <div class="chart-container">
                                        <canvas id="tag-chart"></canvas>
                                    </div>
                                    <div id="tag-list" class="mt-3">
                                        <!-- Tag list will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="date mt-4 text-center">
                    {{ current_date }} | <span class="badge bg-info">Elasticsearch Demo</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Result template (hidden) -->
    <template id="result-template">
        <div class="result-item">
            <h3 class="result-title"></h3>
            <p class="result-content"></p>
            <div class="result-tags"></div>
            <div class="result-score"></div>
        </div>
    </template>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const resultsContainer = document.getElementById('results-container');
            const tagList = document.getElementById('tag-list');
            let tagChart = null;
            
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const query = searchInput.value.trim();
                
                if (query.length === 0) return;
                
                // Show loading indicator
                resultsContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                
                // Send search request
                const formData = new FormData();
                formData.append('query', query);
                
                fetch('/search', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        resultsContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        return;
                    }
                    
                    displayResults(data.results);
                    displayTagStats(data.tag_stats);
                })
                .catch(error => {
                    resultsContainer.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                });
            });
            
            function displayResults(results) {
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="alert alert-info">No results found. Try a different search term.</div>';
                    return;
                }
                
                resultsContainer.innerHTML = `<h2>Search Results (${results.length})</h2>`;
                
                results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    
                    // Title with highlight if available
                    const title = document.createElement('h3');
                    title.className = 'result-title';
                    if (result.highlights && result.highlights.title) {
                        title.innerHTML = result.highlights.title[0];
                    } else {
                        title.textContent = result.title;
                    }
                    resultItem.appendChild(title);
                    
                    // Content with highlight if available
                    const content = document.createElement('p');
                    content.className = 'result-content';
                    if (result.highlights && result.highlights.content) {
                        content.innerHTML = result.highlights.content[0];
                    } else {
                        content.textContent = result.content;
                    }
                    resultItem.appendChild(content);
                    
                    // Tags
                    const tags = document.createElement('div');
                    tags.className = 'result-tags';
                    result.tags.forEach(tag => {
                        const tagBadge = document.createElement('span');
                        tagBadge.className = 'badge bg-secondary me-1';
                        tagBadge.textContent = tag;
                        tags.appendChild(tagBadge);
                    });
                    resultItem.appendChild(tags);
                    
                    // Score
                    const score = document.createElement('div');
                    score.className = 'result-score';
                    score.innerHTML = `<small class="text-muted">Relevance: ${Math.round(result.score * 100) / 100}</small>`;
                    resultItem.appendChild(score);
                    
                    resultsContainer.appendChild(resultItem);
                });
            }
            
            function displayTagStats(tagStats) {
                if (!tagStats || Object.keys(tagStats).length === 0) {
                    tagList.innerHTML = '<p>No tags found in results.</p>';
                    return;
                }
                
                // Sort tags by frequency
                const sortedTags = Object.entries(tagStats)
                    .sort((a, b) => b[1] - a[1]);
                
                // Display tag list
                tagList.innerHTML = '<h4>Popular Tags</h4>';
                const tagListUl = document.createElement('ul');
                tagListUl.className = 'list-group';
                
                sortedTags.forEach(([tag, count]) => {
                    const tagItem = document.createElement('li');
                    tagItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    tagItem.textContent = tag;
                    
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-primary rounded-pill';
                    badge.textContent = count;
                    
                    tagItem.appendChild(badge);
                    tagListUl.appendChild(tagItem);
                });
                
                tagList.appendChild(tagListUl);
                
                // Create or update chart
                const ctx = document.getElementById('tag-chart').getContext('2d');
                
                if (tagChart) {
                    tagChart.destroy();
                }
                
                tagChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedTags.map(item => item[0]),
                        datasets: [{
                            data: sortedTags.map(item => item[1]),
                            backgroundColor: [
                                '#4285F4', '#EA4335', '#FBBC05', '#34A853',
                                '#FF6D01', '#46BDC6', '#7B1FA2', '#0097A7'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
